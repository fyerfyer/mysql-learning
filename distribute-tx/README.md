# MySQL 分布式事务管理系统

## 系统架构

```
┌─────────────────────────────┐
│     应用层 (Application)     │
└──────────────┬──────────────┘
               │
               ▼
┌─────────────────────────────┐
│    事务协调者 (Coordinator)   │
│                             │
│  ┌─────────┐   ┌─────────┐  │
│  │ 事务日志 │   │ 状态管理 │  │
│  └─────────┘   └─────────┘  │
└──────────┬─────────┬────────┘
           │         │
     ┌─────▼─┐   ┌───▼───┐
     │       │   │       │
┌────▼─────┐ │   │ ┌─────▼────┐
│ 参与者 1  │◄┼───┼►│ 参与者 2  │
│(服务 1)   │ │   │ │(服务 2)   │
└────┬─────┘ │   │ └─────┬────┘
     │       │   │       │
┌────▼─────┐ │   │ ┌─────▼────┐
│ 数据库 1  │ │   │ │ 数据库 2  │
└──────────┘ └───┘ └──────────┘
```

## 核心组件

### 1. 事务协调者 (Coordinator)

负责管理整个分布式事务的生命周期，协调各参与者执行准备、提交或回滚操作：

- **事务创建**：生成全局唯一事务ID (XID)
- **准备协调**：通知所有参与者准备事务
- **决策制定**：根据准备阶段结果决定提交或回滚
- **状态管理**：维护事务状态和参与者信息

```go
func (c *TransactionCoordinator) Prepare(xid string, participantActions map[string]func(*gorm.DB) error) (bool, error) {
    // 更新事务状态为准备中
    // 要求所有参与者准备事务
    // 收集所有准备结果
    // 决定是否可以继续提交
}
```

### 2. 事务参与者 (Participant)

表示一个数据库服务，负责执行本地事务操作并响应协调者的指令：

- **资源管理**：管理本地数据库连接
- **本地事务**：执行准备、提交或回滚操作
- **状态报告**：向协调者报告操作结果

```go
func (p *Participant) Prepare(xid string, action func(*gorm.DB) error) (model.OperationResult, error) {
    // 获取资源数据库连接
    // 开始本地事务
    // 执行业务逻辑但不提交
    // 返回准备结果
}
```

### 3. 数据库连接管理器 (DBConnectionManager)

管理与各个服务数据库的连接：

- **连接池管理**：维护多个数据库的连接
- **事务表初始化**：创建分布式事务相关的表结构
- **业务表初始化**：创建业务模型相关的表结构

```go
func (m *DBConnectionManager) InitTransactionTables(coordinatorService string) error {
    // 创建事务相关表
}
```

### 4. 事务模型 (Transaction Model)

定义事务数据结构与状态：

- **事务实体**：记录分布式事务的状态和元数据
- **参与者实体**：记录事务参与者的状态和信息
- **操作结果**：封装事务操作的结果信息

## 二阶段提交原理

### 第一阶段：准备（Prepare）

1. **事务开始**：
    - 应用程序请求开始一个分布式事务
    - 协调者生成全局唯一事务ID (XID)
    - 协调者将事务信息记录到事务表

2. **参与者准备**：
    - 协调者通知所有参与者准备事务
    - 各参与者执行本地事务操作但不提交
    - 各参与者将操作结果报告给协调者
    - 参与者进入"准备就绪"状态，等待最终决定

3. **决策点**：
    - 协调者收集所有参与者的准备结果
    - 如果所有参与者都准备成功，事务进入"已准备"状态
    - 如果任一参与者准备失败，协调者决定回滚事务

### 第二阶段：提交/回滚（Commit/Rollback）

1. **提交流程**：
    - 协调者通知所有参与者提交事务
    - 参与者提交本地事务
    - 参与者向协调者报告提交结果
    - 协调者更新事务状态为"已提交"

2. **回滚流程**：
    - 协调者通知所有参与者回滚事务
    - 参与者回滚本地事务
    - 参与者向协调者报告回滚结果
    - 协调者更新事务状态为"已回滚"

## 故障处理机制

本系统实现了以下故障处理机制：

1. **参与者故障**：
    - 准备阶段的参与者故障导致整个事务回滚
    - 提交阶段的参与者故障被记录并可进行手动恢复

2. **协调者故障**：
    - 事务状态持久化到数据库，支持恢复
    - 参与者状态记录可用于重建事务状态

3. **超时处理**：
    - 协调者设置事务超时时间，避免无限等待
    - 超时后根据当前阶段决定提交或回滚

## 如何运行系统

### 前提条件

- Go 1.16或更高版本
- MySQL 5.7或更高版本
- 创建名为`test_tx`的数据库

### 启动步骤

1. **配置数据库**：
   默认使用localhost:3306的MySQL服务器和test_tx数据库。如需修改，请更新`internal/config/db_config.go`中的配置。

2. **运行示例程序**：
   ```bash
   go run cmd/main.go
   ```

3. **观察输出**：
   程序会依次执行成功事务示例和失败场景示例，并打印事务执行的详细过程。

## 示例场景

系统提供了两类示例：

### 1. 成功事务示例

模拟订单创建过程，涉及三个服务：
- 订单服务：创建订单记录
- 库存服务：扣减商品库存
- 支付服务：创建支付记录

```go
// 创建订单的分布式事务示例
func SimpleOrderTransaction() {
    // 创建事务协调者和参与者
    // 定义参与者操作
    // 执行准备阶段
    // 执行提交阶段
    // 显示事务结果
}
```

### 2. 失败场景示例

展示三种常见的失败场景及其处理：
- 库存不足：准备阶段发现库存不足，事务回滚
- 支付失败：账户余额不足，事务回滚
- 提交阶段失败：某个参与者在提交阶段失败，需要恢复机制

## 代码结构

项目结构如下：

- `cmd/`: 应用入口
    - `main.go`: 主程序，运行示例场景

- `internal/`: 内部实现
    - `config/`: 配置管理
        - `db_config.go`: 数据库配置
    - `coordinator/`: 协调者实现
        - `coordinator.go`: 事务协调者
    - `participant/`: 参与者实现
        - `participant.go`: 事务参与者
    - `db/`: 数据库管理
        - `conn.go`: 数据库连接管理
    - `model/`: 数据模型
        - `transaction.go`: 事务相关模型
        - `business.go`: 业务数据模型

- `examples/`: 示例场景
    - `simple_transaction.go`: 成功事务示例
    - `failure_scenario.go`: 失败场景示例

## 技术要点

- 分布式事务的ACID特性保证
- 二阶段提交（2PC）协议实现
- 并发事务处理与同步
- 事务状态持久化
- 故障恢复设计